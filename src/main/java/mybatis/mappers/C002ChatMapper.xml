<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.chat">
	<resultMap id="classFriend" type="java.util.HashMap">
		<result property="memNum" column="memNum" />
        <result property="memName" column="memName" />
        <result property="openclassId" column="openclassId" />
        <result property="openclassName" column="openclassName" />
    </resultMap> 
    
    <resultMap id="memInfo" type="java.util.HashMap">
    	<result property="memNum" column="memNum"/>
    	<result property="memName" column="memName"/>
    </resultMap>
    
    <resultMap id="chatroomInfo" type="java.util.HashMap">
    	<result property="chatroomId" column="chatroomId"/>
    	<result property="chatroomName" column="chatroomName"/>
    	<result property="memNum" column="memNum"/>
    	<result property="memName" column="memName"/>
    </resultMap>
    
    <!-- 채팅방 목록 가져오기 -->
    <select id="getChatroomList" resultType="C002ChatroomVO" parameterType="java.util.HashMap">
    	<![CDATA[
		    SELECT B.CHATROOMNAME, B.CHATROOMID
			FROM MEMBERCHAT A, CHATROOM B
			WHERE A.CHATROOMID=B.CHATROOMID
			    AND A.MEMNUM = #{memNum, jdbcType=VARCHAR}
			ORDER BY TO_NUMBER(B.CHATROOMID)
		]]>
    </select>
    
    <!-- 학생일 경우 -->
	<!-- 내가 신청한 수업 목록 가져오기 -->
	<select id="getMyClassList" resultType="String" parameterType="java.util.HashMap" >
		<![CDATA[
			SELECT openClassId
			FROM ENROLMENT
		]]>
		<where>
			<if test=" memNum != ''  and  memNum != null">
			<![CDATA[
				memNum = #{memNum,jdbcType=VARCHAR}
			]]>
			</if>
		</where>
	</select>
	
	<!-- 친구 목록 불러오기 // 같은 수업을 듣는 학생 -->
	<select id="getclassFriendList" resultMap="classFriend" parameterType="java.util.HashMap">
		<![CDATA[
			SELECT M.memNum, M.memName, E.openclassId, E.openclassName
			FROM ENROLMENT E, MEMBER M
		]]>
		<where>
			<![CDATA[
				E.MEMNUM = M.MEMNUM
			]]>
			<if test=" memNum != ''  and  memNum != null">
			<![CDATA[
				and M.memNum <> #{memNum, jdbcType=VARCHAR}
			]]>
			</if>
			<choose>
	            <when test="classList.size != 0">
	                and E.openClassId in 
	                <foreach collection="classList" item="item" index="index" separator="," open="(" close=")">
	                    #{item}
	                </foreach>
	            </when>
        	</choose>
		</where>
		<![CDATA[
			ORDER BY TO_NUMBER(E.openclassId), TO_NUMBER(M.memNum)
		]]>
	</select>
	
	<!-- 내가 듣는 수업의 강사 목록 가져오기 -->
	<select id="getTeaList" resultMap="classFriend" parameterType="java.util.HashMap">
		<![CDATA[
			SELECT UNIQUE m.memNum, m.memName, '0' openclassId, '강사' openclassName
			FROM OPENCLASS O, MEMBER M
		]]>
		<where>
			<![CDATA[
				O.memNum = m.memNum
			]]>
			<choose>
	            <when test="classList.size != 0">
	                and O.OPENCLASSID in 
	                <foreach collection="classList" item="item" index="index" separator="," open="(" close=")">
	                    #{item}
	                </foreach>
	            </when>
        	</choose>
		</where>
		<![CDATA[
			ORDER BY TO_NUMBER(M.memNum)
		]]>
	</select>
	
	<!-- 강사일 경우 -->
	<!-- 담당한 수업 목록 가져오기  -->
	<select id="getTeaClassList" resultType="String" parameterType="java.util.HashMap" >
		<![CDATA[
			SELECT openClassId
			FROM OPENCLASS
		]]>
		<where>
			<if test=" memNum != ''  and  memNum != null">
			<![CDATA[
				memNum = #{memNum}
			]]>
			</if>
		</where>
	</select>
	
	<!-- 본인 수업을 듣는 학생 리스트 가져오기  -->
	<select id="getclassStuList" resultMap="classFriend" parameterType="java.util.HashMap">
		<![CDATA[
			SELECT M.memNum, M.memName, E.openclassId, E.openclassName
			FROM ENROLMENT E, MEMBER M
		]]>
		<where>
			<![CDATA[
				E.MEMNUM = M.MEMNUM
			]]>
			<choose>
	            <when test="classList.size != 0">
	                and openClassId in 
	                <foreach collection="classList" item="item" index="index" separator="," open="(" close=")">
	                    #{item}
	                </foreach>
	            </when>
        	</choose>
		</where>
		<![CDATA[
			ORDER BY TO_NUMBER(E.openclassId), TO_NUMBER(M.memNum)
		]]>
	</select>

	<!-- 채팅방에 추가할 멤버 정보 가져오기 -->
	<select id="getmemInfo" resultMap="memInfo" parameterType="java.util.HashMap">
		<![CDATA[
			SELECT memNum, memName
			FROM MEMBER
		]]>
		<where>
			<choose>
	            <when test="memList.size != 0">
	                memNum in 
	                <foreach collection="memList" item="item" index="index" separator="," open="(" close=")">
	                    #{item}
	                </foreach>
	            </when>
        	</choose>
		</where>
		<![CDATA[
			ORDER BY TO_NUMBER(memNum)
		]]>
	</select>
	
	<!-- 생성할 채팅방 번호 만들어 가져오기 / 시퀀스 사용 -->
	<select id="getchatroomId" resultType="String">
		<![CDATA[
			SELECT SEQ_CHATROOM.NEXTVAL FROM DUAL
		]]>
	</select>
	
	<!-- 채팅방 만들기 -->
	<insert id="insertChatroom" parameterType="java.util.HashMap"> 
		<![CDATA[
			INSERT INTO CHATROOM(chatroomId,chatroomName,memNum)
			    VALUES( #{chatroomId,jdbcType=VARCHAR}, 
			    		#{chatroomName,jdbcType=VARCHAR},
			    		#{makeMember,jdbcType=VARCHAR}
			    	)
		]]>
	</insert>
	
	<!-- 생성한 채팅방 멤버 추가하기 -->
	<insert id="insertMemberChat" parameterType="java.util.HashMap">
		<foreach collection="memList" item="item" open="INSERT ALL" close=" SELECT * FROM DUAL" separator=" "> 
			INTO MEMBERCHAT VALUES (#{item}, #{chatroomId}) 
		</foreach>
	</insert>
	
	
	<!-- 방장 번호 알아오기 -->
	<select id="getmakeMember" parameterType="java.util.HashMap">
		<![CDATA[
			SELECT memNum
			FROM CHATROOM
		]]>
		<where>
			<if test=" chatroomId != ''  and  chatroomId != null">
			<![CDATA[
				CHATROOMID = #{chatroomId}
			]]>
			</if>
		</where>
	</select>
	
	<!-- 방이름, 방번호, 참여멤버 이름 가져오기 -->
	<select id="getChatroomInfo" resultMap="chatroomInfo" parameterType="java.util.HashMap">
		<![CDATA[
			SELECT A.CHATROOMID, A.CHATROOMNAME, C.MEMNUM, C.MEMNAME
			FROM CHATROOM A, MEMBERCHAT B, MEMBER C
		]]>
		<where>
			<![CDATA[
				A.CHATROOMID=B.CHATROOMID
	    		AND B.MEMNUM=C.MEMNUM
			]]>
			<if test=" chatroomId != ''  and  chatroomId != null">
				<![CDATA[
					AND A.CHATROOMID  = #{chatroomId}
				]]>
			</if>
		</where>
	</select>
	
</mapper>	